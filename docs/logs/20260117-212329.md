# 実装ログ: Phase 3.4 & 3.5 実装

**日時**: 2026-01-17 21:23 - 21:45

## 目標

Phase 3.4 (プロンプトテンプレート) と Phase 3.5 (デモモード) を TDD で実装する。

## 完了タスク

- [x] 詳細実装計画の作成
  - `docs/plans/20260117-212457-phase3.4-4-implementation.md`
- [x] `tests/test_prompts.py` 作成（13テスト）
- [x] `src/prompts/templates.py` 拡張
- [x] `tests/test_main.py` 作成（4テスト）
- [x] `src/main.py` デモモード実装
- [x] 品質チェック（ruff, mypy, pytest）
- [x] 実装計画の更新

---

## TDD記録

### prompts/templates.py

1. **RED**: `tests/test_prompts.py` 作成 → `ImportError: cannot import name 'format_planner_prompt'`
2. **GREEN**: `src/prompts/templates.py` 実装 → 13テスト PASS

**テスト内容（13件）:**
- Planner: プレースホルダー確認、JSON指示確認、フォーマット関数、空タスクエラー（4件）
- Summarizer: プレースホルダー確認、フォーマット関数、max_length対応（3件）
- Reviewer: 両プレースホルダー確認、リスト結合（2件）
- Writer: 全プレースホルダー確認、参照フォーマット、空参照対応（4件）

### main.py (デモモード)

1. **RED**: `tests/test_main.py` 作成 → `ImportError: cannot import name 'scrape_url'`
2. **修正**: 正しい関数名 (`search`, `scrape`) に修正
3. **GREEN**: `src/main.py` 実装 → 4テスト PASS
4. **修正**: `result.error` → `result.error_message` (mypy エラー修正)

**テスト内容（4件）:**
- demo search: 検索結果の出力
- demo scrape: Markdown の出力
- demo scrape failure: エラーメッセージの出力
- demo requires input: 入力必須エラー

---

## 問題と解決策

### 1. 関数名の不一致

**発生箇所**: `src/main.py`

**エラー内容**:
```
ImportError: cannot import name 'scrape_url' from 'src.tools.scrape'
```

**原因**:
実際の関数名は `scrape` と `search` だったが、計画では `scrape_url` と `search_searxng` と記載していた。

**解決策**:
```python
# 修正前
from src.tools.scrape import scrape_url
from src.tools.search import search_searxng

# 修正後
from src.tools.scrape import scrape
from src.tools.search import search
```

### 2. ScrapeResult の属性名不一致

**発生箇所**: `src/main.py:51`

**エラー内容**:
```
mypy: "ScrapeResult" has no attribute "error"
```

**原因**:
`ScrapeResult` の属性名は `error_message` であり `error` ではなかった。

**解決策**:
```python
# 修正前
print(f"Failed: {result.error}")

# 修正後
print(f"Failed: {result.error_message}")
```

---

## 品質チェック結果

```
pytest: 63 passed
coverage: 88%
mypy: Success: no issues found in 16 source files
ruff check: All checks passed!
```

---

## 作成/変更ファイル一覧

```
tests/test_prompts.py           # 新規作成（13テスト）
tests/test_main.py              # 新規作成（4テスト）
src/prompts/templates.py        # 拡張（フォーマット関数追加）
src/main.py                     # デモモード実装
docs/plans/20260117-212457-phase3.4-4-implementation.md  # 詳細計画
docs/plans/20260117-134549-initial-implementation-plan.md  # 進捗更新
```

---

## 学んだこと

- **モックパスの指定**: `patch("src.main.search")` のように、インポート先のモジュールでパッチする
- **dataclass 属性の確認**: 実装前に既存コードの属性名を確認することが重要

---

## 次回への引き継ぎ

**Phase 3 完了！** デモモードで動作確認可能:

```bash
uv run python -m src.main --demo search "Python programming"
uv run python -m src.main --demo scrape "https://example.com"
```

**Phase 4 開始:**

1. `tests/test_llm.py` 作成 (Red)
2. `src/llm.py` 作成 (Green)
3. 各ノードの TDD 実装
